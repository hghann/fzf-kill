#!/bin/bash

# ========================================================
# fzf-kill macOS Port
# ========================================================

# PARAMETERS THAT CAN BE OVERRIDED BY THE USER (DEFAULTS)
DETAILED_MODE="false"
LOOP_MODE="false"
EXCLUDE_LIST='myprogramtoexcludehere'
# Exported to ensure subshells (like fzf) inherit these options
export FZF_DEFAULT_OPTS="--min-height=20 --prompt 'kill -9 '"
SHOW_ROOT="false"
SHOW_HELP="false"

# Use id -u for portable user ID detection on macOS
CURRENT_UID=$(id -u)

# PARSE PARAMETERS
# ========================================================
for arg in "$@"; do
  [[ "$arg" == *"all"* ]] && DETAILED_MODE="true"
  [[ "$arg" == *"loop"* ]] && LOOP_MODE="true"
  [[ "$arg" == *"showroot"* ]] && SHOW_ROOT="true"
  [[ "$arg" == *"help"* ]] && SHOW_HELP="true"
  [[ "$arg" == *"exclude="* ]] && EXCLUDE_LIST=$(echo "$arg" | cut -d= -f2-)
  [[ "$arg" == *"fzf_default_ops="* ]] && export FZF_DEFAULT_OPTS=$(echo "$arg" | cut -d= -f2-)
done

# FUNCTIONS
# ========================================================

detailed_mode(){
  # macOS ps -ef: PID is col 2, CMD starts at col 8
  local ps_cmd="ps -ef"
  if [[ "$CURRENT_UID" != "0" && "$SHOW_ROOT" == "false" ]]; then
    # Filter for user-owned processes only
    ps_cmd="ps -u $CURRENT_UID -ef"
  fi

  # Extract PID from column 2
  pid=$($ps_cmd | \
    sed 1d | \
    grep -vE "($EXCLUDE_LIST|fzf-kill)" | \
    fzf -m | \
    awk '{print $2}')

  if [[ -n "$pid" ]]; then
    # Kill process and its immediate parent if found
    for p in $pid; do
      ppid=$(ps -p "$p" -o ppid= | tr -d ' ')
      kill -9 "$p" 2>/dev/null
      [[ -n "$ppid" ]] && kill -9 "$ppid" 2>/dev/null
    done
  fi
}

simple_mode(){
  # Simple mode using BSD flags for clean PID and command name output
  if [[ "$CURRENT_UID" != "0" && "$SHOW_ROOT" == "false" ]]; then
    # User-specific processes
    # macOS syntax: -u filters by user, -o defines columns
    pid=$(ps -u "$CURRENT_UID" -o pid,comm | sed 1d)
  else
    # All processes
    pid=$(ps -Ao pid,comm | sed 1d)
  fi

  # Pipe the result through the filters and fzf
  selected_pid=$(echo "$pid" | \
    grep -vE "($EXCLUDE_LIST|fzf-kill)" | \
    awk '{if($2 in seen){}else{seen[$2]=$0; print}}' | \
    fzf -m | \
    awk '{print $1}')

  if [[ -n "$selected_pid" ]]; then
    echo "$selected_pid" | xargs kill -9 2>/dev/null
  fi
}

show_help(){
echo "HELP:
 fzf-kill allows you to kill your programs in a quick and intuitive way.

 # BASIC COMMANDS
 * --parents           Show only parent processes (default).
 * --all               Show both parent and children processes.

 # ADVANCED OPTIONS
 * --exclude           Exclude specific words (e.g., --exclude='chrome|slack').
 * --loop              Stay open even after killing a program.
 * --fzf_default_ops   Override the FZF_DEFAULT_OPTS environment variable.
 * --showroot          List both root and user processes.
"
}

# ENTRY POINT
# ========================================================
while true; do
    if [ "$SHOW_HELP" = "true" ]; then
      show_help
      break
    fi

    if [ "$DETAILED_MODE" = "true" ]; then
      detailed_mode
    else
      simple_mode
    fi

    # Break loop if not in loop mode
    [[ "$LOOP_MODE" == "false" ]] && break
done

